<!DOCTYPE html>
<html lang="sk">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="page-title">Nov√Ω pr√≠spevok - Administr√°cia</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="/style.css">
    <link rel="stylesheet" href="/admin.css">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="/components/admin-header.js" defer></script>
    <style>
        .post-editor-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
            min-height: 100vh;
        }

        .editor-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border-color);
        }

        .editor-header h1 {
            font-size: 2rem;
            color: var(--accent-gold);
            font-family: 'Playfair Display', serif;
        }

        .editor-actions {
            display: flex;
            gap: 1rem;
            align-items: stretch;
        }

        .btn {
            padding: 0 1.5rem;
            height: 48px;
            border: none;
            border-radius: 24px;
            font-size: 0.95rem;
            font-weight: 600;
            letter-spacing: 0.5px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            text-transform: uppercase;
        }

        .btn-primary {
            background-color: var(--accent-gold);
            color: var(--bg-dark);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
        }

        .btn-primary:hover {
            background-color: var(--accent-orange);
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(212, 165, 116, 0.4);
        }

        .btn-secondary {
            background: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
        }

        .btn-secondary:hover {
            border-color: var(--accent-gold);
            color: var(--accent-gold);
            background: rgba(212, 165, 116, 0.05);
        }

        .editor-layout {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 2rem;
        }

        .card {
            background: var(--bg-card);
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            padding: 2rem;
            border: 1px solid var(--border-color);
            margin-bottom: 2rem;
        }

        .form-group {
            margin-bottom: 2rem;
            position: relative;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--accent-gold);
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .form-control {
            width: 100%;
            padding: 1rem 1.2rem;
            border: 1px solid transparent;
            border-bottom: 2px solid var(--border-color);
            border-radius: 8px 8px 0 0;
            font-size: 1.05rem;
            background: rgba(255, 255, 255, 0.03);
            color: var(--text-primary);
            transition: all 0.3s ease;
        }

        .form-control:focus {
            outline: none;
            background: rgba(255, 255, 255, 0.07);
            border-bottom-color: var(--accent-gold);
        }

        textarea.form-control {
            font-family: 'Consolas', 'Monaco', monospace;
            line-height: 1.6;
            min-height: 150px;
            resize: vertical;
            border: 1px solid var(--border-color);
            border-radius: 8px;
        }

        textarea.content-editor {
            min-height: 600px !important;
            font-size: 1.1rem;
        }

        /* Force visibility just in case */
        .form-control {
            color: var(--text-primary) !important;
            opacity: 1 !important;
            visibility: visible !important;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .helper-text {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-top: 0.5rem;
            font-style: italic;
        }

        .preview-pane {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 2rem;
            height: 100%;
            overflow-y: auto;
            max-height: 800px;
        }

        .preview-header {
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 1rem;
            margin-bottom: 1rem;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            font-size: 0.8rem;
            letter-spacing: 1px;
        }

        /* Tabs */
        .lang-tabs {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
            border-bottom: 1px solid var(--border-color);
        }

        .lang-tab {
            padding: 0.75rem 1.5rem;
            background: transparent;
            border: none;
            border-bottom: 2px solid transparent;
            color: var(--text-secondary);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .lang-tab:hover {
            color: var(--accent-gold);
        }

        .lang-tab.active {
            color: var(--accent-gold);
            border-bottom-color: var(--accent-gold);
        }

        .lang-content {
            display: none;
        }

        .lang-content.active {
            display: block;
            animation: fadeIn 0.3s ease-in-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(5px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Markdown Preview Styles */
        .markdown-preview h1,
        .markdown-preview h2,
        .markdown-preview h3 {
            color: var(--accent-gold);
            margin-top: 1.5rem;
            margin-bottom: 0.5rem;
            font-family: 'Playfair Display', serif;
        }

        .markdown-preview p {
            margin-bottom: 1rem;
            line-height: 1.7;
            color: var(--text-primary);
        }

        .markdown-preview blockquote {
            border-left: 4px solid var(--accent-gold);
            padding-left: 1rem;
            margin: 1rem 0;
            font-style: italic;
            color: var(--text-secondary);
        }

        .markdown-preview img {
            max-width: 100%;
            border-radius: 8px;
        }

        .markdown-preview code {
            background: var(--bg-secondary);
            padding: 0.2rem 0.4rem;
            border-radius: 4px;
            font-family: 'Consolas', monospace;
            font-size: 0.9em;
            color: var(--accent-orange);
        }

        .categories-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .category-checkbox {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem;
            background: var(--bg-secondary);
            border-radius: 8px;
            cursor: pointer;
            border: 1px solid transparent;
            position: relative;
            transition: all 0.2s;
        }

        .category-checkbox:hover {
            border-color: var(--accent-gold);
            background: rgba(212, 165, 116, 0.1);
        }

        .category-checkbox input:checked+span {
            color: var(--accent-gold);
            font-weight: 600;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 1rem;
            background: var(--bg-secondary);
            border-radius: 8px;
            cursor: pointer;
        }

        .checkbox-group:hover {
            background: rgba(212, 165, 116, 0.1);
        }

        .thumbnail-upload {
            display: flex;
            gap: 1rem;
            align-items: flex-start;
        }

        .thumbnail-preview {
            width: 200px;
            height: 112px;
            background: var(--bg-secondary);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
            overflow: hidden;
            border: 1px solid var(--border-color);
        }

        .thumbnail-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .thumbnail-actions {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .btn-small {
            height: 36px;
            padding: 0 1rem;
            font-size: 0.85rem;
        }

        .toast {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            padding: 1rem 1.5rem;
            border-radius: 8px;
            background: var(--bg-card);
            color: var(--text-primary);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            gap: 10px;
            animation: slideIn 0.3s ease-out;
            z-index: 9999;
            border: 1px solid var(--border-color);
        }

        .toast.success {
            border-color: var(--emerald);
            color: var(--emerald);
        }

        .toast.error {
            border-color: var(--rose);
            color: var(--rose);
        }

        @keyframes slideIn {
            from {
                transform: translateY(20px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        @keyframes slideOutFade {
            to {
                transform: translateY(20px);
                opacity: 0;
            }
        }

        @media (max-width: 1024px) {
            .editor-layout {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>

<body>
    <div class="post-editor-container">
        <div class="editor-header">
            <h1 id="editor-title">üìù Nov√Ω pr√≠spevok</h1>
            <div class="editor-actions">
                <a href="/admin/posts" class="btn btn-secondary">
                    <i class="fas fa-arrow-left"></i> Sp√§≈•
                </a>
                <button id="save-draft-btn" class="btn btn-secondary">
                    <i class="fas fa-save"></i> Ulo≈æi≈• koncept
                </button>
                <button id="publish-btn" class="btn btn-primary">
                    <i class="fas fa-check"></i> Publikova≈•
                </button>
            </div>
        </div>

        <div id="message-container"></div>

        <div class="editor-layout">
            <!-- Left Column: Content -->
            <div class="main-column">
                <div class="card">
                    <!-- Language Tabs -->
                    <div class="lang-tabs">
                        <button class="lang-tab active" data-tab="en">üá¨üáß English (Default)</button>
                        <button class="lang-tab" data-tab="sk">üá∏üá∞ Slovenƒçina</button>
                    </div>

                    <!-- English Content -->
                    <div id="lang-pane-en" class="lang-content active">
                        <div class="form-group">
                            <label for="title-en">Title (English) *</label>
                            <input type="text" id="title-en" class="form-control" placeholder="Post title..." required>
                        </div>

                        <div class="form-group">
                            <label for="excerpt-en">Excerpt (English)</label>
                            <textarea id="excerpt-en" class="form-control" rows="3"
                                placeholder="Short description..."></textarea>
                        </div>

                        <div class="form-group">
                            <label for="content-en">Content (English Markdown)</label>
                            <textarea id="content-en" class="form-control content-editor"
                                placeholder="# Heading..."></textarea>
                        </div>

                        <div class="form-group">
                            <label for="meta-description-en">Meta Description (English SEO)</label>
                            <textarea id="meta-description-en" class="form-control" rows="2"
                                placeholder="SEO description..."></textarea>
                        </div>
                    </div>

                    <!-- Slovak Content -->
                    <div id="lang-pane-sk" class="lang-content">
                        <div class="form-group">
                            <label for="title-sk">N√°zov (Slovensky)</label>
                            <input type="text" id="title-sk" class="form-control" placeholder="N√°zov pr√≠spevku...">
                            <div class="helper-text">Ak nevypln√≠te, pou≈æije sa anglick√Ω n√°zov</div>
                        </div>

                        <div class="form-group">
                            <label for="excerpt-sk">Kr√°tky popis (Slovensky)</label>
                            <textarea id="excerpt-sk" class="form-control" rows="3"
                                placeholder="Kr√°tky popis..."></textarea>
                        </div>

                        <div class="form-group">
                            <label for="content-sk">Obsah (Slovensk√Ω Markdown)</label>
                            <textarea id="content-sk" class="form-control content-editor"
                                placeholder="# Nadpis..."></textarea>
                        </div>

                        <div class="form-group">
                            <label for="meta-description-sk">Meta popis (Slovensky SEO)</label>
                            <textarea id="meta-description-sk" class="form-control" rows="2"
                                placeholder="SEO popis..."></textarea>
                        </div>
                    </div>

                </div>

                <!-- Preview Card -->
                <div class="card">
                    <div class="preview-section">
                        <div class="preview-header">üëÅÔ∏è ≈Ωiv√Ω N√°hƒæad (<span id="preview-lang-label">English</span>)</div>
                        <div id="preview-content" class="markdown-preview">
                            <p style="color: var(--text-secondary);">N√°hƒæad sa zobraz√≠ tu automaticky pri p√≠san√≠...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column: Settings -->
            <div class="sidebar-column">
                <div class="card">
                    <div class="form-group">
                        <label for="slug">URL Slug (Shared)</label>
                        <input type="text" id="slug" class="form-control" placeholder="auto-generated-slug">
                        <div class="helper-text">Shared across all languages</div>
                    </div>

                    <div class="form-group">
                        <label>Kateg√≥rie</label>
                        <div id="categories-container" class="categories-grid"></div>
                    </div>

                    <div class="form-group">
                        <label>Nastavenia</label>
                        <div class="checkbox-group">
                            <input type="checkbox" id="is-featured">
                            <label for="is-featured" style="margin:0; cursor:pointer;">‚≠ê Featured Post</label>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Media</label>
                        <div class="form-group">
                            <label for="youtube-id">YouTube ID</label>
                            <input type="text" id="youtube-id" class="form-control" placeholder="e.g. dQw4w9WgXcQ">
                        </div>

                        <div class="form-group">
                            <label for="soundcloud-url">SoundCloud URL</label>
                            <input type="text" id="soundcloud-url" class="form-control"
                                placeholder="https://soundcloud.com/...">
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Thumbnail</label>
                        <div class="thumbnail-upload">
                            <div class="thumbnail-preview" id="thumbnail-preview">
                                <i class="fas fa-image" style="font-size: 2rem;"></i>
                            </div>
                            <div class="thumbnail-actions">
                                <input type="file" id="thumbnail-file" accept="image/*" style="display: none;">
                                <button type="button" class="btn btn-small btn-secondary"
                                    onclick="document.getElementById('thumbnail-file').click()">
                                    Upload
                                </button>
                                <button type="button" id="fetch-youtube-thumb-btn" class="btn btn-small btn-secondary">
                                    From YouTube
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let postId = null;
        let categories = [];
        let currentThumbnailPath = null;
        let currentTab = 'en';

        // Tabs Logic
        document.querySelectorAll('.lang-tab').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const lang = btn.getAttribute('data-tab');
                currentTab = lang;

                // Toggle active tab
                document.querySelectorAll('.lang-tab').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');

                // Toggle content
                document.querySelectorAll('.lang-content').forEach(c => c.classList.remove('active'));
                document.getElementById(`lang-pane-${lang}`).classList.add('active');

                // Update preview label
                document.getElementById('preview-lang-label').textContent = lang === 'en' ? 'English' : 'Slovenƒçina';
                updatePreview();
            });
        });

        const pathParts = window.location.pathname.split('/');
        const editIndex = pathParts.indexOf('edit');
        if (editIndex > 0 && pathParts[editIndex - 1]) {
            postId = pathParts[editIndex - 1];
            document.getElementById('editor-title').textContent = 'üìù Upravi≈• pr√≠spevok';
            document.getElementById('page-title').textContent = 'Upravi≈• pr√≠spevok';
        }

        async function loadCategories() {
            try {
                const response = await fetch('/api/posts/categories/all');
                const data = await response.json();
                if (data.success) {
                    categories = data.data;
                    renderCategories();
                }
            } catch (error) { console.error(error); }
        }

        function renderCategories(selectedCategories = []) {
            const container = document.getElementById('categories-container');
            container.innerHTML = categories.map(category => `
                <label class="category-checkbox">
                    <input type="checkbox" value="${category.id}" 
                        ${selectedCategories.includes(category.id) ? 'checked' : ''}>
                    <span>${category.name}</span>
                </label>
            `).join('');
        }

        async function loadPost() {
            if (!postId) return;
            try {
                // Fetch post with ALL translations
                const response = await fetch(`/api/posts/by-id/${postId}`);
                const data = await response.json();
                if (!data.success) throw new Error(data.error);

                const post = data.data;

                // Load Shared Data
                document.getElementById('slug').value = post.slug || '';
                document.getElementById('youtube-id').value = post.youtube_id || '';
                document.getElementById('soundcloud-url').value = post.soundcloud_url || '';
                document.getElementById('is-featured').checked = post.is_featured || false;

                if (post.thumbnail_path) {
                    currentThumbnailPath = post.thumbnail_path;
                    updateThumbnailPreview(post.thumbnail_path);
                }

                const selectedCategories = post.categories ? post.categories.map(c => c.id) : [];
                renderCategories(selectedCategories);

                // Load Translations
                // Backend return translations object { en: {...}, sk: {...} } OR just flat fields if no translations
                // Check if translations exist
                // Check if translations exist
                const translations = post.translations || {};

                // Populate fields
                ['en', 'sk'].forEach(lang => {
                    let trans = translations[lang];

                    // Fallback to legacy
                    if (!trans && lang === 'en') {
                        trans = {
                            title: post.title,
                            content: post.content,
                            excerpt: post.excerpt,
                            meta_description: post.meta_description
                        };
                    }

                    trans = trans || {};

                    const titleEl = document.getElementById(`title-${lang}`);
                    const contentEl = document.getElementById(`content-${lang}`);
                    const excerptEl = document.getElementById(`excerpt-${lang}`);
                    const metaEl = document.getElementById(`meta-description-${lang}`);

                    if (titleEl) titleEl.value = trans.title || '';
                    if (contentEl) contentEl.value = trans.content || '';
                    if (excerptEl) excerptEl.value = trans.excerpt || '';
                    if (metaEl) metaEl.value = trans.meta_description || '';
                });
                console.log('Post data loaded into form.');

                updatePreview();
            } catch (error) {
                showMessage('error', error.message);
            }
        }

        function updatePreview() {
            // Get content based on active tab
            const content = document.getElementById(`content-${currentTab}`).value;
            const previewContent = document.getElementById('preview-content');

            if (content.trim()) {
                previewContent.innerHTML = marked.parse(content);
            } else {
                previewContent.innerHTML = '<p style="color: var(--text-secondary);">N√°hƒæad sa zobraz√≠ tu...</p>';
            }
        }

        function updateThumbnailPreview(path) {
            const preview = document.getElementById('thumbnail-preview');
            if (!path) {
                preview.innerHTML = '<i class="fas fa-image" style="font-size: 2rem;"></i>';
                return;
            }
            const filename = path.split('/').pop();
            // Try to show optimized webp
            const src = `/images/300/${filename.replace(/\.[^/.]+$/, "")}.webp`;
            preview.innerHTML = `<img src="${src}" onerror="this.src='/thumbnails/originals/${filename}'">`;
        }

        // --- Event Listeners and Save ---

        document.getElementById('content-en').addEventListener('input', () => { if (currentTab === 'en') updatePreview(); });
        document.getElementById('content-sk').addEventListener('input', () => { if (currentTab === 'sk') updatePreview(); });

        async function savePost(status) {
            // Gather data
            const titleEn = document.getElementById('title-en').value;
            const titleSk = document.getElementById('title-sk').value;

            if (!titleEn && !titleSk) {
                showMessage('error', 'Title is required (at least in one language)');
                return;
            }

            const translations = {};
            if (document.getElementById('title-en').value) {
                translations.en = {
                    title: document.getElementById('title-en').value,
                    content: document.getElementById('content-en').value,
                    excerpt: document.getElementById('excerpt-en').value,
                    meta_description: document.getElementById('meta-description-en').value
                };
            }
            if (document.getElementById('title-sk').value) {
                translations.sk = {
                    title: document.getElementById('title-sk').value,
                    content: document.getElementById('content-sk').value,
                    excerpt: document.getElementById('excerpt-sk').value,
                    meta_description: document.getElementById('meta-description-sk').value
                };
            }

            const selectedCategories = Array.from(document.querySelectorAll('#categories-container input:checked'))
                .map(input => parseInt(input.value));

            const postData = {
                translations,
                slug: document.getElementById('slug').value || null,
                youtube_id: document.getElementById('youtube-id').value || null,
                soundcloud_url: document.getElementById('soundcloud-url').value || null,
                is_featured: document.getElementById('is-featured').checked,
                status,
                categories: selectedCategories
            };

            if (currentThumbnailPath) {
                postData.thumbnail_path = currentThumbnailPath;
            }

            try {
                const url = postId ? `/api/posts/${postId}` : '/api/posts';
                const method = postId ? 'PUT' : 'POST';

                const response = await fetch(url, {
                    method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(postData)
                });
                const data = await response.json();
                if (!data.success) throw new Error(data.error);

                if (!postId) {
                    postId = data.data.id;
                    window.history.replaceState({}, '', `?id=${postId}`);
                }
                showMessage('success', 'Ulo≈æen√©!');
                setTimeout(() => window.location.href = '/admin/posts', 1000);
            } catch (error) {
                showMessage('error', error.message);
            }
        }

        document.getElementById('save-draft-btn').addEventListener('click', () => savePost('draft'));
        document.getElementById('publish-btn').addEventListener('click', () => savePost('published'));

        // Thumbnail Upload
        document.getElementById('thumbnail-file').addEventListener('change', async (e) => {
            if (!postId) { showMessage('error', 'Save post first'); return; }
            const file = e.target.files[0];
            const formData = new FormData();
            formData.append('thumbnail', file);
            try {
                const res = await fetch(`/api/posts/${postId}/upload-thumbnail`, { method: 'POST', body: formData });
                const data = await res.json();
                if (data.success) {
                    currentThumbnailPath = data.data.thumbnail_path;
                    updateThumbnailPreview(currentThumbnailPath);
                    showMessage('success', 'Uploaded');
                } else throw new Error(data.error);
            } catch (e) { showMessage('error', e.message); }
        });

        // YouTube Thumbnail
        document.getElementById('fetch-youtube-thumb-btn').addEventListener('click', async () => {
            if (!postId) { showMessage('error', 'Save post first'); return; }
            const ytid = document.getElementById('youtube-id').value;
            try {
                const res = await fetch(`/api/posts/${postId}/thumbnail-from-youtube`, {
                    method: 'POST', body: JSON.stringify({ youtube_id: ytid }), headers: { 'Content-Type': 'application/json' }
                });
                const data = await res.json();
                if (data.success) {
                    currentThumbnailPath = data.data.thumbnail_path;
                    updateThumbnailPreview(currentThumbnailPath);
                    showMessage('success', 'Fetched');
                } else throw new Error(data.error);
            } catch (e) { showMessage('error', e.message); }
        })

        function showMessage(type, message) {
            const container = document.getElementById('message-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerText = message;
            container.appendChild(toast);
            setTimeout(() => toast.remove(), 4000);
        }

        // Init
        loadCategories().then(() => { if (postId) loadPost(); });

    </script>
</body>

</html>